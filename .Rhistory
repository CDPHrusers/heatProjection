), by = . (quartile, year, STATE_NAME)] %>%
melt.data.table(id.vars = c("quartile", "year", "STATE_NAME"), variable.name = "smoke_level") %>% mutate(svi_theme = "Minority",
region = ifelse(STATE_NAME %in% westStates, "west", "not west"))%>% data.table()
HT <- merged[R_PL_THEMES != -999, .(quartile = quartify(R_PL_THEME4), light, medium, heavy, STATE_NAME, year)] %>%
.[, .(
light = sum(light, na.rm = T),
medium = sum(medium, na.rm = T),
heavy = sum(heavy, na.rm = T)
), by = . (quartile, year, STATE_NAME)] %>%
melt.data.table(id.vars = c("quartile", "year", "STATE_NAME"), variable.name = "smoke_level") %>% mutate(svi_theme = "HousingTransportation",
region = ifelse(STATE_NAME %in% westStates, "west", "not west"))%>% data.table()
QTable <- data.table(bind_rows(SES, HC, MSL, HT))
QTable[quartile != "missing", .(personDays = sum(as.numeric(value))), by = .(smoke_level, quartile, svi_theme)] %>%
ggplot() + geom_bar(stat="identity",position = "dodge",aes(x=svi_theme, y=personDays/1000000000, fill=quartile)) +facet_grid(smoke_level ~ ., scales="free_y")
QTable[quartile != "missing", .(personDays = sum(as.numeric(value))), by = .(smoke_level, quartile, svi_theme, region)] %>%
ggplot() + geom_bar(stat="identity",position = "stack",aes(x=quartile, y=personDays/1000000000, fill=region)) +facet_grid(smoke_level ~ svi_theme, scales="free_y")
bind_rows({
QTable[quartile != "missing", .(region = "US", personDays = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme)]
},
{
QTable[quartile != "missing", .(personDays = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)]
}) %>% fwrite("~/tempZip/mmwr_svi_region_quartiles.csv")
westStates <- c("California","Oregon","Washington")
SES <- merged[R_PL_THEMES != -999, .(quartile = quartify(R_PL_THEME1), light, medium, heavy, STATE_NAME, year)] %>%
.[, .(
light = sum(light, na.rm = T),
medium = sum(medium, na.rm = T),
heavy = sum(heavy, na.rm = T)
), by = . (quartile, year, STATE_NAME)] %>%
melt.data.table(id.vars = c("quartile", "year", "STATE_NAME"), variable.name = "smoke_level")  %>% mutate(svi_theme = "SES",
region = ifelse(STATE_NAME %in% westStates,  "west", "not west")) %>% data.table()
HC <- merged[R_PL_THEMES != -999, .(quartile = quartify(R_PL_THEME2), light, medium, heavy, STATE_NAME, year)] %>%
.[, .(
light = sum(light, na.rm = T),
medium = sum(medium, na.rm = T),
heavy = sum(heavy, na.rm = T)
), by = . (quartile, year, STATE_NAME)] %>%
melt.data.table(id.vars = c("quartile", "year", "STATE_NAME"), variable.name = "smoke_level") %>% mutate(svi_theme = "HousingComposition",
region = ifelse(STATE_NAME %in% westStates,  "west", "not west"))%>% data.table()
MSL <- merged[R_PL_THEMES != -999, .(quartile = quartify(R_PL_THEME3), light, medium, heavy, STATE_NAME, year)] %>%
.[, .(
light = sum(light, na.rm = T),
medium = sum(medium, na.rm = T),
heavy = sum(heavy, na.rm = T)
), by = . (quartile, year, STATE_NAME)] %>%
melt.data.table(id.vars = c("quartile", "year", "STATE_NAME"), variable.name = "smoke_level") %>% mutate(svi_theme = "Minority",
region = ifelse(STATE_NAME %in% westStates, "west", "not west"))%>% data.table()
HT <- merged[R_PL_THEMES != -999, .(quartile = quartify(R_PL_THEME4), light, medium, heavy, STATE_NAME, year)] %>%
.[, .(
light = sum(light, na.rm = T),
medium = sum(medium, na.rm = T),
heavy = sum(heavy, na.rm = T)
), by = . (quartile, year, STATE_NAME)] %>%
melt.data.table(id.vars = c("quartile", "year", "STATE_NAME"), variable.name = "smoke_level") %>% mutate(svi_theme = "HousingTransportation",
region = ifelse(STATE_NAME %in% westStates, "west", "not west"))%>% data.table()
QTable <- data.table(bind_rows(SES, HC, MSL, HT))
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme)] %>%
ggplot() + geom_bar(stat="identity",position = "dodge",aes(x=svi_theme, y=billion_person_days, fill=quartile)) +facet_grid(smoke_level ~ ., scales="free_y")
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)] %>%
ggplot() + geom_bar(stat="identity",position = "stack",aes(x=quartile, y=billion_person_days, fill=region)) +facet_grid(smoke_level ~ svi_theme, scales="free_y")
bind_rows({
QTable[quartile != "missing", .(region = "US", billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme)]
},
{
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)]
}) %>% fwrite("~/tempZip/mmwr_svi_region_quartiles.csv")
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)] %>%
ggplot() + geom_bar(stat="identity",position = "stack",aes(x=quartile, y=billion_person_days, fill=region)) +facet_grid(smoke_level ~ svi_theme, scales="free_y") +coord_flip()
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)] %>%
ggplot() + geom_bar(stat="identity",position = "stack",aes(x=quartile, y=billion_person_days, fill=region)) +facet_grid( svi_theme ~ smoke_level, scales="free_y") +coord_flip()
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)] %>%
ggplot() + geom_bar(stat="identity",position = "stack",aes(x=quartile, y=billion_person_days, fill=region)) +facet_grid( svi_theme ~ smoke_level, scales="free_x") +coord_flip()
bind_rows({
QTable[quartile != "missing", .(region = "US", billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme)]
},
{
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)]
}) %>% fwrite("~/tempZip/persondays_by_svi_raw.csv")
bind_rows({
QTable[quartile != "missing", .(region = "US", billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme)]
},
{
QTable[quartile != "missing", .(billion_person_days = sum(as.numeric(value))/1000000000), by = .(smoke_level, quartile, svi_theme, region)]
}) %>% fwrite("~/tempZip/persondays_by_svi_raw.csv")
rm(list = ls())
library(tidyverse)
library(sf)
library(data.table)
stateKey <- fread("~/GitHub/WFSmokeExp/stateKey.csv") %>%
mutate(charST = ifelse(stFIPS<10, paste0("0",stFIPS), as.character(stFIPS))) %>%
rename(STATEFP = stFIPS)
tableList <- fread("https://www2.census.gov/geo/docs/reference/cenpop2010/blkgrp/CenPop2010_Mean_BG.txt")
pop <- tableList[,.(totalPOP = sum(POPULATION)), by=.(STATEFP)] %>% merge(stateKey)
tableListTract <- fread("https://www2.census.gov/geo/docs/reference/cenpop2010/tract/CenPop2010_Mean_TR.txt")
smokeFile <- fread("~/data/smokeFile.csv")[,date := as.Date(as.character(date),"%Y%m%d")]
setkey(smokeFile, date, STATEFP, COUNTYFP, TRACTCE, BLKGRPCE)
smokeFile <-copy(smokeFile)
xposedPOP.stateYear  <- smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = max(light, na.rm = T),
mediumdays = max(medium, na.rm = T),
heavydays = max(heavy, na.rm = T),
POP = mean(POPULATION, na.rm = T)),
by=.(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, year)] %>%
.[, .(lightPOP = sum(POP*lightdays),
mediumPOP = sum(POP*mediumdays),
heavyPOP = sum(POP*heavydays)), by =.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = max(light, na.rm = T),
mediumdays = max(medium, na.rm = T),
heavydays = max(heavy, na.rm = T),
POP = mean(POPULATION, na.rm = T)),
by=.(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, year)] %>%
.[, .(lightPOP = sum(POP*lightdays),
mediumPOP = sum(POP*mediumdays),
heavyPOP = sum(POP*heavydays)), by =.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = max(light, na.rm = T),
mediumdays = max(medium, na.rm = T),
heavydays = max(heavy, na.rm = T),
POP = mean(POPULATION, na.rm = T)),
by=.(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, year)]
ExposedPOP.stateYear  <- smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = max(light, na.rm = T),
mediumdays = max(medium, na.rm = T),
heavydays = max(heavy, na.rm = T),
POP = mean(POPULATION, na.rm = T)),
by=.(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, year)] %>%
.[, .(lightPOP = sum(POP*lightdays),
mediumPOP = sum(POP*mediumdays),
heavyPOP = sum(POP*heavydays)), by =.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
ExposedPOP.stateYear
ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)]
ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>%
.[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST charST)]
ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST charST)]
ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)]
ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
bind_rows({ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear)
bind_rows({ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP)]
bind_rows({ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP
)]
bind_rows({ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level")
bind_rows({ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level") %>% na.omit()
bind_rows({ExposedPOP.stateYear[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level") %>% na.omit() %>%
fwrite("~/MMWR/pct_exposed_by_year_state.csv")
smokeFile
smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = sum(light*POPULATION, na.rm = T),
mediumdays = sum(medium*POPULATION, na.rm = T),
heavydays = sum(heavy*POPULATION, na.rm = T)),
by=.(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, year)]
smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = sum(light*POPULATION, na.rm = T),
mediumdays = sum(medium*POPULATION, na.rm = T),
heavydays = sum(heavy*POPULATION, na.rm = T)),
by=.(STATEFP, year)]
pds.stateYear  <- smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = sum(light*POPULATION, na.rm = T),
mediumdays = sum(medium*POPULATION, na.rm = T),
heavydays = sum(heavy*POPULATION, na.rm = T)),
by=.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
pds.stateYear
pds.stateYear
bind_rows({na.omit(ExposedPOP.stateYear)[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level") %>% na.omit() %>%
fwrite("~/MMWR/pct_exposed_by_year_state.csv")
bind_rows({na.omit(ExposedPOP.stateYear)[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level") %>% na.omit() %>%
fwrite("~/MMWR/pct_exposed_by_year_state.csv")
pds.stateYear
bind_rows({na.omit(pds.stateYear)[, .(lightdays = sum(lightdays, na.rm=T),
mediumdays = sum(mediumdays, na.rm=T),
heavydays = sum(heavydays, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightdays, mediumdays, heavydays, totalPOP, stateName, ST, charST)]
}, pds.stateYear)
bind_rows({na.omit(ExposedPOP.stateYear)[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level", value.name = "pct_exposed") %>% na.omit() %>%
fwrite("~/MMWR/pct_exposed_by_year_state.csv")
bind_rows({na.omit(pds.stateYear)[, .(lightdays = sum(lightdays, na.rm=T),
mediumdays = sum(mediumdays, na.rm=T),
heavydays = sum(heavydays, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightdays, mediumdays, heavydays, totalPOP, stateName, ST, charST)]
}, pds.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightdays,
medium = mediumdays,
heavy = heavydays,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level", value.name = "persondays") %>% na.omit() %>%
fwrite("~/MMWR/persondays_by_year_state.csv")
pds.stateYear  <- smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = sum(light*POPULATION, na.rm = T),
mediumdays = sum(medium*POPULATION, na.rm = T),
heavydays = sum(heavy*POPULATION, na.rm = T)),
by=.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
bind_rows({na.omit(pds.stateYear)[, .(lightdays = sum(lightdays, na.rm=T),
mediumdays = sum(mediumdays, na.rm=T),
heavydays = sum(heavydays, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightdays, mediumdays, heavydays, totalPOP, stateName, ST, charST)]
}, pds.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightdays,
medium = mediumdays,
heavy = heavydays,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level", value.name = "persondays")
bind_rows({na.omit(pds.stateYear)[, .(lightdays = sum(lightdays, na.rm=T),
mediumdays = sum(mediumdays, na.rm=T),
heavydays = sum(heavydays, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightdays, mediumdays, heavydays, totalPOP, stateName, ST, charST)]
}, pds.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightdays,
medium = mediumdays,
heavy = heavydays,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level", value.name = "persondays") %>% na.omit() %>%
fwrite("~/MMWR/persondays_by_year_state.csv")
ExposedPOP.stateYear  <- smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = max(light, na.rm = T),
mediumdays = max(medium, na.rm = T),
heavydays = max(heavy, na.rm = T),
POP = mean(POPULATION, na.rm = T)),
by=.(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, year)] %>%
.[, .(lightPOP = sum(POP*lightdays),
mediumPOP = sum(POP*mediumdays),
heavyPOP = sum(POP*heavydays)), by =.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
bind_rows({na.omit(ExposedPOP.stateYear)[, .(lightPOP = sum(lightPOP, na.rm=T),
mediumPOP = sum(mediumPOP, na.rm=T),
heavyPOP = sum(heavyPOP, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightPOP, mediumPOP, heavyPOP, totalPOP, stateName, ST, charST)]
}, ExposedPOP.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightPOP/totalPOP,
medium = mediumPOP/totalPOP,
heavy = heavyPOP/totalPOP,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level", value.name = "pct_exposed") %>% na.omit() %>%
fwrite("~/MMWR/pct_exposed_by_year_state.csv")
#
############ create persondays_by_year_state table ##################
#
pds.stateYear  <- smokeFile[,year := year(date)] %>%
replace_na(list(
light = 0,
medium = 0,
heavy = 0
)) %>%
.[,.(lightdays = sum(light*POPULATION, na.rm = T),
mediumdays = sum(medium*POPULATION, na.rm = T),
heavydays = sum(heavy*POPULATION, na.rm = T)),
by=.(STATEFP, year)] %>%
merge(pop, by = "STATEFP",all.x=T)
bind_rows({na.omit(pds.stateYear)[, .(lightdays = sum(lightdays, na.rm=T),
mediumdays = sum(mediumdays, na.rm=T),
heavydays = sum(heavydays, na.rm=T),
totalPOP = sum(totalPOP, na.rm=T),
STATEFP = 999,
stateName = "US",
ST = "US",
charST = "999"), by = .(year)] %>% .[,.(STATEFP, year, lightdays, mediumdays, heavydays, totalPOP, stateName, ST, charST)]
}, pds.stateYear) %>%
.[,.(state_name = stateName,
year = year,
light = lightdays,
medium = mediumdays,
heavy = heavydays,
total_pop = totalPOP
)] %>%
melt.data.table(id.vars = c("state_name", "year", "total_pop"), variable.name = "smoke_level", value.name = "persondays") %>% na.omit() %>%
fwrite("~/MMWR/persondays_by_year_state.csv")
library(devtools)
devtools::install_github("CDPHrusers/heatProjection/heatProjectR")
